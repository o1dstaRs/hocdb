name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: master

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Build C Bindings
      run: zig build c-bindings

    - name: Set up library path
      run: echo "LD_LIBRARY_PATH=$(pwd)/zig-out/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    # Run Go Tests (needs C bindings to compile)


    - name: Run Core Tests
      run: zig build test --summary all

    - name: Run Benchmarks
      run: zig build bench

    - name: Run Python Tests
      run: python3 bindings/python/test_query.py

    - name: Run Go Tests
      run: |
        export DYLD_LIBRARY_PATH=$(pwd)/zig-out/lib:$DYLD_LIBRARY_PATH
        export LD_LIBRARY_PATH=$(pwd)/zig-out/lib:$LD_LIBRARY_PATH
        go test -v bindings/go/hocdb_test.go bindings/go/hocdb.go

    - name: Run C++ Tests
      run: |
        clang++ -std=c++17 bindings/c/test_cpp.cpp -o bindings/c/test_cpp -I bindings/c -L zig-out/lib -lhocdb_c -Wl,-rpath,zig-out/lib
        bindings/c/test_cpp
        rm bindings/c/test_cpp

    - name: Run C Recovery Test
      run: |
        clang -o bindings/c/test_auto_inc_recovery bindings/c/test_auto_inc_recovery.c -I bindings/c -L zig-out/lib -lhocdb_c -Wl,-rpath,zig-out/lib
        ./bindings/c/test_auto_inc_recovery
        rm bindings/c/test_auto_inc_recovery

    - name: Build Node.js Bindings
      run: zig build bindings

    - name: Run Node.js Tests
      run: node bindings/node/test.js

    - name: Run Bun Tests
      run: bun run bindings/bun/test.ts