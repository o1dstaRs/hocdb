name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: master

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    # ... existing steps ...

    - name: Run Go Tests
      run: |
        cd bindings/go
        go test -v
        
    - name: Build and Run C++ Tests
      run: |
        mkdir -p test_binaries
        
        # Compile C++ test using Zig's C++ compiler wrapper
        zig c++ -o test_binaries/cpp_test bindings/cpp/test.cpp -I zig-out/include -L zig-out/lib -lhocdb_c -std=c++17
        
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/zig-out/lib
        ./test_binaries/cpp_test
    
    - name: Install System Dependencies (kcov)
      run: |
        sudo apt-get update
        sudo apt-get install -y kcov

    - name: Run Zig Tests with Coverage
      run: |
        # 1. Compile the test binary ('kcov-test') without running it yet
        # Note: If your tests are in src/root.zig, change 'src/main.zig' to 'src/root.zig' below
        zig test src/main.zig --main-pkg-path . -femit-bin=kcov-test
        
        # 2. Run kcov on the binary
        # This executes the tests and generates the report in 'coverage-out'
        kcov --include-pattern=src coverage-out ./kcov-test

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./coverage-out
        fail_ci_if_error: true
        
    # --- END COVERAGE BLOCK ---

    - name: Run Benchmarks
      run: zig build bench

    - name: Build Node.js Bindings
      run: zig build bindings

    - name: Run Node.js Tests
      run: node bindings/node/test.js

    - name: Run Bun Tests
      run: bun run bindings/bun/test.ts

    - name: Build C Bindings
      run: zig build c-bindings

    - name: Build and Run C Tests
      run: |
        mkdir -p test_binaries
        
        # Compile C test using Zig's C compiler wrapper
        zig cc -o test_binaries/c_simple_test bindings/c/simple_test.c -I zig-out/include -L zig-out/lib -lhocdb_c
        
        # Run with library path set
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/zig-out/lib
        ./test_binaries/c_simple_test
        
        # Compile C bench
        zig cc -o test_binaries/c_test_bench bindings/c/test_bench.c -I zig-out/include -L zig-out/lib -lhocdb_c
        
        # Run C bench
        ./test_binaries/c_test_bench

    - name: Build and Run C++ Tests
      run: |
        mkdir -p test_binaries
        
        # Compile C++ test using Zig's C++ compiler wrapper
        zig c++ -o test_binaries/cpp_test bindings/cpp/test.cpp -I zig-out/include -L zig-out/lib -lhocdb_c -std=c++17
        
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/zig-out/lib
        ./test_binaries/cpp_test